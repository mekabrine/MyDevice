name: Build Unsigned IPA

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-unsigned-ipa:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Xcode Version
        run: xcodebuild -version

      - name: Detect project + scheme
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          XCODEPROJ="$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)"
          if [ -z "$XCODEPROJ" ]; then
            echo "No .xcodeproj found in repo root."
            echo "Files here:"
            ls -la
            echo "Searching for .xcodeproj anywhere:"
            find . -maxdepth 4 -name "*.xcodeproj" -print || true
            exit 1
          fi

          echo "Using project: $XCODEPROJ"

          # Get first scheme from xcodebuild -list -json
          SCHEME="$(xcodebuild -list -json -project "$XCODEPROJ" | python3 -c "import json,sys; d=json.load(sys.stdin); s=(d.get('project',{}).get('schemes') or []); print(s[0] if s else '')")"
          if [ -z "$SCHEME" ]; then
            echo "No schemes found. Make sure your scheme is Shared in Xcode (Manage Schemes -> Shared)."
            xcodebuild -list -project "$XCODEPROJ"
            exit 1
          fi

          echo "Using scheme: $SCHEME"
          echo "xcodeproj=$XCODEPROJ" >> "$GITHUB_OUTPUT"
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      - name: Build (iphoneos, no code signing)
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -project "${{ steps.detect.outputs.xcodeproj }}" \
            -scheme "${{ steps.detect.outputs.scheme }}" \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_IDENTITY="" \
            build \
            -derivedDataPath build

      - name: Package unsigned .ipa
        shell: bash
        run: |
          set -euo pipefail

          APP_PATH="$(find build/Build/Products -maxdepth 6 -type d -name "*.app" | head -n 1 || true)"
          if [ -z "$APP_PATH" ] || [ ! -d "$APP_PATH" ]; then
            echo "App not found under build/Build/Products."
            find build -maxdepth 8 -type d -name "*.app" -print || true
            exit 1
          fi

          APP_BASENAME="$(basename "$APP_PATH")"   # e.g. MyDevice.app
          APP_NAME="${APP_BASENAME%.app}"          # e.g. MyDevice
          echo "Packaging: $APP_BASENAME"

          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" "Payload/$APP_BASENAME"

          IPA_NAME="${APP_NAME}-unsigned.ipa"
          rm -f "$IPA_NAME"
          /usr/bin/zip -r "$IPA_NAME" Payload

          echo "IPA_NAME=$IPA_NAME" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-ipa
          path: ${{ env.IPA_NAME }}
